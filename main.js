!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="docs",n(n.s=4)}([function(e,t,n){"use strict";n.r(t),n.d(t,"NUM_ROW",(function(){return r})),n.d(t,"NUM_COLUMN",(function(){return o})),n.d(t,"PIXEL_SIZE",(function(){return i})),n.d(t,"SQUARE_SIZE",(function(){return a})),n.d(t,"LINE_CLEAR_DELAY",(function(){return s})),n.d(t,"BOARD_HEIGHT",(function(){return c})),n.d(t,"BOARD_WIDTH",(function(){return d})),n.d(t,"DISPLAY_FULL_WIDTH",(function(){return u})),n.d(t,"BOARD_TOP_MARGIN",(function(){return l})),n.d(t,"NEXT_BOX_WIDTH",(function(){return S})),n.d(t,"VACANT",(function(){return h})),n.d(t,"RED_COLOR",(function(){return f})),n.d(t,"BLUE_COLOR",(function(){return E})),n.d(t,"WHITE_COLOR",(function(){return g})),n.d(t,"SquareState",(function(){return p})),n.d(t,"COLOR_1",(function(){return I})),n.d(t,"COLOR_2",(function(){return A})),n.d(t,"COLOR_3",(function(){return D})),n.d(t,"COLOR_PALETTE",(function(){return m})),n.d(t,"Direction",(function(){return _})),n.d(t,"REWARDS",(function(){return y})),n.d(t,"CalculatePushdownPoints",(function(){return T})),n.d(t,"GetGravity",(function(){return L})),n.d(t,"GameState",(function(){return M})),n.d(t,"DASSpeed",(function(){return v})),n.d(t,"DASBehavior",(function(){return U})),n.d(t,"StartingBoardType",(function(){return N}));const r=20,o=10,i=3,a=8*i,s=18,c=a*r,d=a*o,u=a*(o+6),l=2*a,S=5*a,h="black",f="red",E="#2105f2",g="white",p={EMPTY:0,COLOR1:1,COLOR2:2,COLOR3:3},I={0:"rgb(0,88,248)",1:"rgb(0,168,0)",2:"rgb(216,0,204)",3:"rgb(0,88,248)",4:"rgb(228,0,88",5:"rgb(88,248,152)",6:"rgb(248,56,0)",7:"rgb(104,68,252)",8:"rgb(0,88,248)",9:"rgb(248,56,0)"},A={0:"rgb(60,188,252)",1:"rgb(148,248,24)",2:"rgb(248,120,248)",3:"rgb(88,216,84)",4:"rgb(88,248,152)",5:"rgb(104,136,252)",6:"rgb(124,124,124)",7:"rgb(168,0,32)",8:"rgb(248,56,0)",9:"rgb(252,160,68)"},D=Object.assign(I),m={1:I,2:A,3:D},_=Object.freeze({LEFT:1,RIGHT:2,DOWN:3,UP:4}),y={1:40,2:100,3:300,4:1200},R={0:48,1:43,2:38,3:33,4:28,5:23,6:18,7:13,8:8,9:6,10:5,11:5,12:5,13:4,14:4,15:4,16:3,17:3,18:3,19:2,29:1};function T(e){return e>=16?e-6:e}function L(e){return e<=18?R[e]:e<29?2:1}const M={FIRST_PIECE:"first_piece",RUNNING:"running",PAUSED:"paused",GAME_OVER:"game_over",START_SCREEN:"start_screen",ARE:"are",LINE_CLEAR:"line_clear",EDIT_STARTING_BOARD:"edit_starting_board"},v=Object.freeze({STANDARD:"standard",SLOW_MEDIUM:"slow_medium",MEDIUM:"medium",FAST:"fast",FASTDAS:"Fast DAS"}),U=Object.freeze({STANDARD:"standard",ALWAYS_CHARGED:"always_charged",CHARGE_ON_PIECE_SPAWN:"charge_on_piece_spawn"}),N=Object.freeze({EMPTY:"empty",DIG_PRACTICE:"dig practice",CUSTOM:"custom"})},function(e,t,n){"use strict";n.d(t,"k",(function(){return a})),n.d(t,"f",(function(){return s})),n.d(t,"i",(function(){return c})),n.d(t,"j",(function(){return d})),n.d(t,"b",(function(){return u})),n.d(t,"e",(function(){return l})),n.d(t,"h",(function(){return S})),n.d(t,"g",(function(){return h})),n.d(t,"c",(function(){return f})),n.d(t,"d",(function(){return E})),n.d(t,"a",(function(){return g}));const{DASSpeed:r,StartingBoardType:o,DASBehavior:i}=n(0),a=Object.freeze({REQUIRED:"required",DEFAULT:"default",NONE:"none"}),s=Object.freeze({DASSpeed:r.STANDARD,DASBehavior:i.STANDARD,DroughtModeEnabled:!1,DiggingHintsEnabled:!1,GameSpeedMultiplier:1,ParityHintsEnabled:!1,PieceSequence:"",Transition10Lines:!1,StartingBoardType:o.EMPTY,StartingLevel:15}),c={},d={DASSpeed:{type:a.DEFAULT,value:r.MEDIUM},DASBehavior:{type:a.DEFAULT,value:i.CHARGE_ON_PIECE_SPAWN}},u={DiggingHintsEnabled:{type:a.DEFAULT,value:!0},StartingBoardType:{type:a.REQUIRED,value:o.DIG_PRACTICE}},l={StartingLevel:{type:a.REQUIRED,value:29},DASSpeed:{type:a.DEFAULT,value:r.MEDIUM},DASBehavior:{type:a.DEFAULT,value:i.CHARGE_ON_PIECE_SPAWN}},S={GameSpeedMultiplier:{type:a.DEFAULT,value:.5},StartingLevel:{type:a.REQUIRED,value:29},DASSpeed:{type:a.DEFAULT,value:r.MEDIUM},DASBehavior:{type:a.DEFAULT,value:i.CHARGE_ON_PIECE_SPAWN}},h={GameSpeedMultiplier:{type:a.DEFAULT,value:.5},StartingLevel:{type:a.REQUIRED,value:19},Transition10Lines:{type:a.REQUIRED,value:!0},DASBehavior:{type:a.DEFAULT,value:i.CHARGE_ON_PIECE_SPAWN}},f={DroughtModeEnabled:{type:a.REQUIRED,value:!0}},E={StartingBoardType:{type:a.REQUIRED,value:o.CUSTOM}},g={PieceSequence:{type:a.DEFAULT,value:""}}},function(e,t,n){"use strict";n.r(t),n.d(t,"shouldTransitionEvery10Lines",(function(){return i})),n.d(t,"shouldTransitionEveryLine",(function(){return a})),n.d(t,"getStartingLevel",(function(){return s})),n.d(t,"shouldShowDiggingHints",(function(){return c})),n.d(t,"shouldShowParityHints",(function(){return d})),n.d(t,"getGameSpeedMultiplier",(function(){return u})),n.d(t,"getFrameSkipCount",(function(){return l})),n.d(t,"shouldReduceLongBars",(function(){return S})),n.d(t,"getPieceSequence",(function(){return h})),n.d(t,"getStartingBoardType",(function(){return f})),n.d(t,"shouldSetDASChargeOnPieceStart",(function(){return E})),n.d(t,"isDASAlwaysCharged",(function(){return g})),n.d(t,"getDASChargeAfterTap",(function(){return p})),n.d(t,"getDASWallChargeAmount",(function(){return I})),n.d(t,"getDASChargedFloor",(function(){return A})),n.d(t,"GetDASUnchargedFloor",(function(){return D})),n.d(t,"getDASTriggerThreshold",(function(){return m}));var r=n(0);const o=n(3);function i(){return o.getTransition10Lines()}function a(){return!1}function s(){return o.getStartingLevel()}function c(){return o.getDiggingHintsEnabled()}function d(){return o.getParityHintsEnabled()}function u(){return o.getGameSpeedMultiplier()}function l(){return Math.round(1/o.getGameSpeedMultiplier())}function S(){return o.getDroughtModeEnabled()}function h(){return o.getPieceSequence()}function f(){return o.getStartingBoardType()}function E(){const e=o.getDASBehavior();return e==r.DASBehavior.ALWAYS_CHARGED||e==r.DASBehavior.CHARGE_ON_PIECE_SPAWN}function g(){return o.getDASBehavior()==r.DASBehavior.ALWAYS_CHARGED}function p(){return o.getDASBehavior()==r.DASBehavior.ALWAYS_CHARGED?10:0}function I(){switch(o.getDASSpeed()){case r.DASSpeed.SLOW_MEDIUM:return 12;case r.DASSpeed.FAST:return 10;default:return m()}}function A(){return 10}function D(){return 0}function m(){let e;const t=o.getDASSpeed();switch(t){case r.DASSpeed.STANDARD:e=6;break;case r.DASSpeed.FAST:case r.DASSpeed.FASTDAS:e=4;break;case r.DASSpeed.SLOW_MEDIUM:case r.DASSpeed.MEDIUM:e=5;break;default:throw new Error("Unknown DAS speed: "+t)}return 10+e}},function(e,t,n){"use strict";n.r(t),n.d(t,"getStartingLevel",(function(){return _})),n.d(t,"getTransition10Lines",(function(){return y})),n.d(t,"getDroughtModeEnabled",(function(){return R})),n.d(t,"getDiggingHintsEnabled",(function(){return T})),n.d(t,"getParityHintsEnabled",(function(){return L})),n.d(t,"getGameSpeedMultiplier",(function(){return M})),n.d(t,"getDASSpeed",(function(){return v})),n.d(t,"getDASBehavior",(function(){return U})),n.d(t,"getPieceSequence",(function(){return N})),n.d(t,"getStartingBoardType",(function(){return C})),n.d(t,"loadPreset",(function(){return O}));var r=n(0),o=n(1);const i=document.getElementById("das-speed-dropdown"),a=document.getElementById("das-behavior-dropdown"),s=document.getElementById("game-speed-dropdown"),c=document.getElementById("starting-board"),d=document.getElementById("drought-checkbox"),u=document.getElementById("digging-hints-checkbox"),l=document.getElementById("parity-hints-checkbox"),S=document.getElementById("transition-10-checkbox"),h=document.getElementById("piece-sequence"),f=document.getElementById("level-select"),E=function(){if(document.cookie){console.log("cookie:",document.cookie);const e=document.cookie.split(";")[0];return JSON.parse(unescape(e))}return JSON.parse(JSON.stringify(o.f))}(),g=[r.DASSpeed.STANDARD,r.DASSpeed.SLOW_MEDIUM,r.DASSpeed.MEDIUM,r.DASSpeed.FAST,r.DASSpeed.FASTDAS],p=[r.DASBehavior.STANDARD,r.DASBehavior.ALWAYS_CHARGED,r.DASBehavior.CHARGE_ON_PIECE_SPAWN],I=[r.StartingBoardType.EMPTY,r.StartingBoardType.DIG_PRACTICE,r.StartingBoardType.CUSTOM];function A(){document.cookie=escape(JSON.stringify(E))+"; expires=Thu, 18 Dec 2030 12:00:00 UTC",console.log("cookie:",document.cookie)}function D(){for(const e of document.getElementById("level-choice-buttons").children)e.id.split("-")[1]===f.value?e.classList.add("selected"):e.classList.remove("selected")}function m(e,t){switch(e){case"DASSpeed":i.value=g.findIndex(e=>e==t);break;case"DASBehavior":a.value=p.findIndex(e=>e==t);break;case"DroughtModeEnabled":d.checked=t;break;case"DiggingHintsEnabled":u.checked=t;break;case"GameSpeedMultiplier":s.value=t;break;case"ParityHintsEnabled":l.checked=t;break;case"PieceSequence":h.value=t;break;case"Transition10Lines":S.checked=t;break;case"StartingBoardType":c.value=I.findIndex(e=>e==t);break;case"StartingLevel":f.value=t,D()}}function _(){const e=parseInt(f.value);return Math.max(e,0)}function y(){return S.checked}function R(){return d.checked}function T(){return u.checked}function L(){return l.checked}function M(){return s.value}function v(){const e=parseInt(i.value);return g[e]}function U(){const e=parseInt(a.value);return p[e]}function N(){const e=h.value.toUpperCase();let t="";for(const n of e)["I","O","L","J","T","S","Z"].includes(n)&&(t+=n);return t}function C(){return I[c.value]}function O(e){const t=[["DASSpeed",i],["DASBehavior",a],["DroughtModeEnabled",d],["DiggingHintsEnabled",u],["GameSpeedMultiplier",s],["ParityHintsEnabled",l],["PieceSequence",h],["Transition10Lines",S],["StartingBoardType",c],["StartingLevel",f]];for(const n of t){const t=n[0],r=n[1],i="StartingLevel"==t?r.parentElement:r.parentElement.parentElement,a=r.parentElement.parentElement;t in e?(m(t,e[t].value),i.classList.add("selected-row"),e[t].type==o.k.REQUIRED&&a.classList.add("disabled-row")):(m(t,E[t]),i.classList.remove("selected-row"),a.classList.remove("disabled-row"))}}i.addEventListener("change",e=>{E.DASSpeed=v(),A()}),a.addEventListener("change",e=>{E.DASBehavior=U(),A()}),u.addEventListener("change",e=>{E.DiggingHintsEnabled=T(),A()}),l.addEventListener("change",e=>{E.ParityHintsEnabled=L(),A()}),f.addEventListener("change",e=>{D()}),[0,5,8,9,15,18,19,29].forEach(e=>{document.getElementById("level-"+e).addEventListener("click",t=>{f.value=e,D(),E.StartingLevel=_(),A()})})},function(e,t,n){"use strict";n.r(t),n.d(t,"GetCurrentPiece",(function(){return Re})),n.d(t,"GetLevel",(function(){return Te})),n.d(t,"GetIsPaused",(function(){return Le})),n.d(t,"calcParity",(function(){return be}));const r={Z:[[[[0,0,0,0],[0,1,1,0],[0,0,1,1]],[[0,0,0,1],[0,0,1,1],[0,0,1,0]]],2,"Z"],S:[[[[0,0,0,0],[0,0,1,1],[0,1,1,0]],[[0,0,1,0],[0,0,1,1],[0,0,0,1]]],3,"S"],T:[[[[0,0,0,0],[0,1,1,1],[0,0,1,0]],[[0,0,1,0],[0,1,1,0],[0,0,1,0]],[[0,0,1,0],[0,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,1],[0,0,1,0]]],1,"T"],O:[[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]],1,"O"],L:[[[[0,0,0,0],[0,1,1,1],[0,1,0,0]],[[0,1,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,1],[0,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,1]]],2,"L"],I:[[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]],1,"I"],J:[[[[0,0,0,0],[0,1,1,1],[0,0,0,1]],[[0,0,1,0],[0,0,1,0],[0,1,1,0]],[[0,1,0,0],[0,1,1,1],[0,0,0,0]],[[0,0,1,1],[0,0,1,0],[0,0,1,0]]],3,"J"]},o=Object.values(r),i=n(2);function a(){this.sequence=[],this.startOfRandomSequence=0,this.readIndex=0}function s(e){let t=Math.floor(Math.random()*(o.length+1));const n=t!==o.length?o[t][2]:"";(t==o.length||n===e||i.shouldReduceLongBars()&&"I"==n)&&(t=Math.floor(Math.random()*o.length));return o[t][2]}a.prototype.generatePieceSequence=function(){const e=i.getPieceSequence();console.log("peice sequence:",e);let t=0;if(e.length>0)for(let n=0;n<e.length;n++)this.sequence[n]=e.charAt(n),t++;for(;t<2e3;){const e=0==t?null:this.sequence[t-1];this.sequence[t]=s(e),t++}console.log(this.sequence),this.readIndex=0,this.startOfRandomSequence=e.length},a.prototype.getReadIndex=function(){return this.readIndex},a.prototype.setReadIndex=function(e){this.readIndex=e},a.prototype.getNextPiece=function(){const e=this.sequence[this.readIndex];return this.readIndex++,r[e]},a.prototype.getStatusDisplay=function(){return console.log(this.readIndex,this.startOfRandomSequence),this.readIndex<this.startOfRandomSequence?["Piece ",this.readIndex+"/"+this.startOfRandomSequence]:["Random","Piece"]};var c=n(0);const d=document.getElementById("paste-area"),u=document.getElementById("pasted-image");let l=!1,S=[];function h(e,t){var n;this.board=e,this.canvas=t,n=this,d.onpaste=function(e){for(var t=(e.clipboardData||e.originalEvent.clipboardData).items,r=null,o=0;o<t.length;o++)0===t[o].type.indexOf("image")&&(r=t[o].getAsFile());if(null!==r){var i=new FileReader;i.onload=function(e){u.onload=function(){n.getBoardStateFromImage(u)},u.src=e.target.result},i.readAsDataURL(r)}}}h.prototype.resetBoard=function(){for(let e=0;e<c.NUM_ROW;e++)for(let t=0;t<c.NUM_COLUMN;t++)this.board[e][t]=l?S[e][t]:c.SquareState.EMPTY},h.prototype.didLoadBoardStateFromImage=function(){return l},h.prototype.getBoardStateFromImage=function(e){var t=document.getElementById("dummy-canvas"),n=t.getContext("2d");t.width=e.width,t.height=e.height,n.drawImage(e,0,0),this.resetBoard();const r=(e.height/20+e.width/10)/2-.1;for(let e=0;e<c.NUM_COLUMN;e++)for(let t=0;t<c.NUM_ROW;t++){const o=Math.round((e+.5)*r),i=Math.round((t+.5)*r),a=n.getImageData(o,i,1,1).data;Math.max(a[0],a[1],a[2])>30?(n.fillStyle="RED",this.board[t][e]=c.SquareState.COLOR2):(n.fillStyle="GREEN",this.board[t][e]=c.SquareState.EMPTY),n.fillRect(o,i,3,3)}!function(e,t,n){let r=!1;for(let o=c.NUM_ROW-1;o>=0;o--)if(r)for(let t=0;t<c.NUM_COLUMN;t++)e[o][t]=c.SquareState.EMPTY;else{let i=!0;for(let t=0;t<c.NUM_COLUMN;t++)if(e[o][t]!=c.SquareState.EMPTY){i=!1;break}i&&(r=!0,t.fillStyle="BLACK",t.fillRect(0,0,n*c.NUM_COLUMN,o*n))}}(this.board,n,r),S=JSON.parse(JSON.stringify(this.board)),this.canvas.drawBoard(),l=!0,setTimeout(()=>{t.style.display="none"},3e3)};const f=document.getElementById("main-canvas"),E=f.getContext("2d"),g=n(2);function p(e){this.board=e}function I(e,t,n){return t<0||t>=c.NUM_COLUMN||e<0||e>=c.NUM_ROW||n[e][t]!=c.SquareState.EMPTY}function A(e,t,n){E.fillStyle=n,E.fillRect(t*c.SQUARE_SIZE+c.PIXEL_SIZE,e*c.SQUARE_SIZE+c.PIXEL_SIZE,c.SQUARE_SIZE-3*c.PIXEL_SIZE,c.SQUARE_SIZE-3*c.PIXEL_SIZE)}function D(e,t,n){for(let r=0;r<c.NUM_COLUMN;r++)n[e][r]==c.SquareState.EMPTY&&A(e,r,t)}function m(e){if((e=Math.floor(e))<0)throw new Error("Can't convert negative num to hex");return e<10?""+e:e<16?["a","b","c","d","e","f"][e-10]:"f"}function _(e,t){this.rotationList=e[0],this.colorId=e[1],this.id=e[2],this.board=t,this.rotationIndex=0,this.activeTetromino=this.rotationList[this.rotationIndex],this.x=3,this.y="I"==this.id?-2:-1}f.setAttribute("height",c.SQUARE_SIZE*c.NUM_ROW),f.setAttribute("width",c.SQUARE_SIZE*(c.NUM_COLUMN+7)),p.prototype.drawLineClears=function(e,t){if(t>=15)return;const n=5+Math.floor(t/3),r=9-n;for(const t of e)E.fillStyle="black",E.fillRect(r*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.SQUARE_SIZE,c.SQUARE_SIZE),E.fillRect(n*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.SQUARE_SIZE,c.SQUARE_SIZE)},p.prototype.drawSquare=function(e,t,n,r=!1){if(n==c.VACANT)return E.fillStyle="black",void E.fillRect(e*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.SQUARE_SIZE,c.SQUARE_SIZE);E.fillStyle=n,E.fillRect(e*c.SQUARE_SIZE,t*c.SQUARE_SIZE,7*c.PIXEL_SIZE,7*c.PIXEL_SIZE),r&&n!==c.VACANT&&(E.fillStyle="white",E.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE,5*c.PIXEL_SIZE,5*c.PIXEL_SIZE)),n!==c.VACANT&&(E.fillStyle="white",E.fillRect(e*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE),E.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE),E.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE),E.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE+c.PIXEL_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE))},p.prototype.drawNextBox=function(e){const t=c.NUM_COLUMN+1;if(E.fillStyle="BLACK",E.fillRect(t*c.SQUARE_SIZE,8*c.SQUARE_SIZE,5*c.SQUARE_SIZE,4.5*c.SQUARE_SIZE),null!=e){const n="I"===e.id||"O"===e.id?t+.5:t,r="I"===e.id?7.75:8.25,o=c.COLOR_PALETTE[e.colorId][Te()%10];for(let t=0;t<e.activeTetromino.length;t++)for(let i=0;i<e.activeTetromino[t].length;i++)e.activeTetromino[t][i]&&this.drawSquare(n+i,r+t,o,1===e.colorId)}},p.prototype.drawScoreDisplay=function(e){const t=c.NEXT_BOX_WIDTH,n=c.BOARD_WIDTH+c.SQUARE_SIZE,r=.5*c.SQUARE_SIZE,o=("0".repeat(6)+e).slice(-6);this.drawMultiLineText(["SCORE",o],n,r,t,"center")},p.prototype.drawLinesDisplay=function(e){const t=c.NEXT_BOX_WIDTH,n=c.BOARD_WIDTH+c.SQUARE_SIZE,r=3*c.SQUARE_SIZE,o=("0".repeat(3)+e).slice(-3);this.drawMultiLineText(["LINES",o],n,r,t,"center")},p.prototype.drawLevelDisplay=function(e){const t=c.NEXT_BOX_WIDTH,n=c.BOARD_WIDTH+c.SQUARE_SIZE,r=14*c.SQUARE_SIZE,o=("0".repeat(2)+e).slice(-2);this.drawMultiLineText(["LEVEL",o],n,r,t,"center")},p.prototype.drawTetrisRateDisplay=function(e,t){const n=c.NEXT_BOX_WIDTH,r=c.BOARD_WIDTH+c.SQUARE_SIZE,o=17*c.SQUARE_SIZE;let i=0;t>0&&(i=4*e/t);const a=parseInt(100*i);this.drawMultiLineText(["TRT",a+"%"],r,o,n,"center")},p.prototype.drawPieceStatusDisplay=function(e){const t=c.NEXT_BOX_WIDTH,n=c.BOARD_WIDTH+c.SQUARE_SIZE,r=6*c.SQUARE_SIZE;this.drawMultiLineText(e,n,r,t,"center")},p.prototype.drawMultiLineText=function(e,t,n,r,o){E.clearRect(t,n,r,20*e.length),E.textAlign="center",E.font="18px 'Press Start 2P'",E.fillStyle="BLACK";const i="center"==o?r/2:0;let a=0;for(let r of e)E.fillText(r.toUpperCase(),t+i,n+20*(a+1)),a++},p.prototype.drawPiece=function(e){if(null==e)return;const t=Te(),n="T"===e.id||"O"===e.id||"I"===e.id;for(let r=0;r<e.activeTetromino.length;r++)for(let o=0;o<e.activeTetromino[r].length;o++)e.activeTetromino[r][o]&&(0!==e.colorId?this.drawSquare(e.x+o,e.y+r,c.COLOR_PALETTE[e.colorId][t%10],n):this.drawSquare(e.x+o,e.y+r,c.VACANT,n))},p.prototype.unDrawPiece=function(e){if(null!=e)for(let t=0;t<e.activeTetromino.length;t++)for(let n=0;n<e.activeTetromino[t].length;n++)e.activeTetromino[t][n]&&this.drawSquare(e.x+n,e.y+t,c.VACANT,!1)},p.prototype.drawCurrentPiece=function(){this.drawPiece(Re())},p.prototype.unDrawCurrentPiece=function(){this.unDrawPiece(Re())},p.prototype.drawBoard=function(){const e=Te();for(let t=0;t<c.NUM_ROW;t++)for(let n=0;n<c.NUM_COLUMN;n++){let r=this.board[t][n];0!==r?this.drawSquare(n,t,c.COLOR_PALETTE[r][e%10],1===r):this.drawSquare(n,t,c.VACANT,1===r)}g.shouldShowDiggingHints()&&this.drawDiggingHints(),g.shouldShowParityHints()&&this.drawParityHints()},p.prototype.drawDiggingHints=function(){const e=function(e){for(let t=0;t<c.NUM_ROW;t++)for(let n=0;n<c.NUM_COLUMN;n++)if(e[t][n]==c.SquareState.EMPTY&&I(t-1,n,e)&&I(t+1,n,e)&&I(t,n-1,e)&&I(t,n+1,e))return[t,n];return[]}(this.board),t=function(e){let t=c.NUM_ROW-1,n=[];for(;!I(t,c.NUM_COLUMN-1,e);)t--;for(;t>=0&&I(t,c.NUM_COLUMN-1,e);)n.push(t),t--;return n}(this.board);if(e.length>0){const t=e[0],n=e[1];let r=[],o=t-1;for(;o>=0&&I(o,n,this.board);)r.push(o),o-=1;const i=(t+.45)*c.SQUARE_SIZE,a=(n+.45)*c.SQUARE_SIZE,s=c.SQUARE_SIZE/4;E.fillStyle="yellow",E.beginPath(),E.arc(a,i,s,0,2*Math.PI,!1),E.fill();for(let e of r)D(e,"#842424",this.board)}else if(t.length>0)for(let e of t)D(e,"#215E30",this.board)},p.prototype.drawParityHints=function(){const e=[];for(let t=0;t<c.NUM_COLUMN;t++)e[t]=be(t-2,t+3);let t=[];for(let n=0;n<c.NUM_COLUMN;n++){let r=0,o=0;if([n-1,n,n+1].forEach(t=>{t>=0&&t<c.NUM_COLUMN&&(r+=e[t],o+=1)}),0==o)throw new Error("None added");t[n]=r/o}for(let e=0;e<c.NUM_COLUMN;e++){const n=t[e];for(let t=0;t<c.NUM_ROW;t++)if(this.board[t][e]==c.SquareState.EMPTY){const r=m(Math.max(5*n-4,0));A(t,e,"#ff0000"+r+r)}}},_.prototype.equals=function(e){return this.id===e.id},_.prototype.getHeightFromBottom=function(){let e=0;for(let t=0;t<this.activeTetromino.length;t++)for(let n=0;n<this.activeTetromino[t].length;n++)this.activeTetromino[t][n]&&(e=Math.max(e,this.y+t));return c.NUM_ROW-e},_.prototype.shouldLock=function(){return this.collision(0,1,this.activeTetromino)},_.prototype.moveDown=function(){this.y++},_.prototype.moveRight=function(){return!this.collision(1,0,this.activeTetromino)&&(this.x++,!0)},_.prototype.moveLeft=function(){return!this.collision(-1,0,this.activeTetromino)&&(this.x--,!0)},_.prototype.rotate=function(e){const t=e?1:-1,n=(this.rotationIndex+t+this.rotationList.length)%this.rotationList.length,r=this.rotationList[n];this.collision(0,0,r)||(this.rotationIndex=n,this.activeTetromino=this.rotationList[this.rotationIndex])},_.prototype.lock=function(){for(let e=0;e<this.activeTetromino.length;e++)for(let t=0;t<this.activeTetromino[e].length;t++){if(!this.activeTetromino[e][t])continue;const n=this.y+e,r=this.x+t;n>=0&&n<c.NUM_ROW&&r>=0&&r<c.NUM_COLUMN&&(this.board[this.y+e][this.x+t]=this.colorId)}},_.prototype.collision=function(e,t,n){for(let r=0;r<n.length;r++)for(let o=0;o<n[r].length;o++){if(!n[r][o])continue;let i=this.x+o+e,a=this.y+r+t;if(i<0||i>=c.NUM_COLUMN||a>=c.NUM_ROW)return!0;if(!(a<0)&&0!=this.board[a][i])return!0}return!1};const y=n(2),R=document.getElementById("das-stats");function T(e,t,n,r,o,i,a,s){this.resetLocalVariables(),this.togglePauseFunc=i,this.moveDownFunc=e,this.moveLeftFunc=t,this.moveRightFunc=n,this.rotateLeftFunc=r,this.rotateRightFunc=o,this.getGameStateFunc=a,this.getAREFunc=s}function L(e){return!Le()&&(e==c.GameState.RUNNING||e==c.GameState.FIRST_PIECE)}T.prototype.getIsSoftDropping=function(){return this.isSoftDropping},T.prototype.getCellsSoftDropped=function(){return this.cellSoftDropped},T.prototype.onPieceLock=function(){y.shouldSetDASChargeOnPieceStart()?this.setDASCharge(y.getDASWallChargeAmount()):this.setDASCharge(Math.min(y.getDASWallChargeAmount(),this.dasCharge))},T.prototype.resetLocalVariables=function(){this.leftHeld=!1,this.rightHeld=!1,this.downHeld=!1,this.isSoftDropping=!1,this.cellSoftDropped=0,this.dasCharge=y.getDASTriggerThreshold(),this.softDroppedLastFrame=!1},T.prototype.handleInputsThisFrame=function(){if(this.downHeld+this.leftHeld+this.rightHeld>1)return this.isSoftDropping=!1,void(this.cellSoftDropped=0);if(this.isSoftDropping&&!this.softDroppedLastFrame){return this.moveDownFunc()?this.cellSoftDropped+=1:(this.isSoftDropping=!1,this.cellSoftDropped=0),void(this.softDroppedLastFrame=!0)}this.softDroppedLastFrame=!1,this.leftHeld?this.handleHeldDirection(c.Direction.LEFT):this.rightHeld&&this.handleHeldDirection(c.Direction.RIGHT)},T.prototype.keyDownListener=function(e){if(e.repeat)return;switch(e.keyCode){case 37:this.leftHeld=!0,e.preventDefault();break;case 39:this.rightHeld=!0,e.preventDefault();break;case 40:this.downHeld=!0}const t=this.getGameStateFunc();if(L(t))switch(e.keyCode){case 37:this.handleTappedDirection(c.Direction.LEFT);break;case 39:this.handleTappedDirection(c.Direction.RIGHT);break;case 90:this.rotateLeftFunc();break;case 88:this.rotateRightFunc()}else switch(e.keyCode){case 90:case 88:console.log("rotate rejected, state: ",this.getGameStateFunc())}if(function(e){return!Le()&&e==c.GameState.RUNNING}(t))switch(e.keyCode){case 40:this.isSoftDropping=!0}},T.prototype.keyUpListener=function(e){37==e.keyCode?this.leftHeld=!1:39==e.keyCode?this.rightHeld=!1:40==e.keyCode&&(this.downHeld=!1,this.isSoftDropping=!1,this.cellSoftDropped=0)},T.prototype.tryShiftPiece=function(e){const t=e==c.Direction.LEFT?this.moveLeftFunc():this.moveRightFunc();return t||this.setDASCharge(y.getDASTriggerThreshold()),t},T.prototype.handleHeldDirection=function(e){const t=y.getDASTriggerThreshold();if(this.setDASCharge(Math.min(t,this.dasCharge+1)),this.dasCharge==t){this.tryShiftPiece(e)&&this.setDASCharge(y.getDASChargedFloor())}},T.prototype.handleTappedDirection=function(e){L(this.getGameStateFunc())&&(this.setDASCharge(y.getDASChargeAfterTap()),this.tryShiftPiece(e))},T.prototype.setDASCharge=function(e){this.dasCharge=e,this.refreshDebugText()},T.prototype.refreshDebugText=function(){let e="",t="";for(let e=0;e<this.dasCharge;e++)t+="|";0==this.dasCharge&&(t="."),e+=this.dasCharge+"/"+y.getDASTriggerThreshold()+"\n"+t,R.innerText=e};const M=document.getElementById("main-canvas");function v(e,t){this.board=e,this.canvas=t,this.mouseIsDown=!1,this.squaresToggled=new Set,this.dragMode=U.NONE}const U=Object.freeze({ADDING:"adding",REMOVING:"removing",NONE:"none"});function N(e){const t=M.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top;return[Math.floor(r/c.SQUARE_SIZE),Math.floor(n/c.SQUARE_SIZE)]}function C(e,t){return e+","+t}v.prototype.toggleCell=function(e,t){this.squaresToggled.add(C(e,t)),this.board[e][t]=this.board[e][t]==c.SquareState.EMPTY?c.SquareState.COLOR1:c.SquareState.EMPTY,this.canvas.drawBoard(),this.canvas.drawCurrentPiece()},v.prototype.onMouseDown=function(e){let t,n;[t,n]=N(e),this.mouseIsDown=!0,this.dragMode=this.board[t][n]==c.SquareState.EMPTY?U.ADDING:U.REMOVING,this.toggleCell(t,n)},v.prototype.onMouseDrag=function(e){if(!this.mouseIsDown)return;let t,n;[t,n]=N(e);(this.dragMode==U.ADDING?this.board[t][n]==c.SquareState.EMPTY:this.board[t][n]!=c.SquareState.EMPTY)&&!this.squaresToggled.has(C(t,n))&&this.toggleCell(t,n)},v.prototype.onMouseUp=function(e){this.mouseIsDown=!1,this.squaresToggled=new Set};const{NUM_COLUMN:O,NUM_ROW:P,SquareState:b}=n(0);function w(e,t){this.board=e}function B(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}w.prototype.loadEmptyBoard=function(){for(let e=0;e<P;e++)for(let t=0;t<O;t++)this.board[e][t]=b.EMPTY},w.prototype.loadStandardBoard=function(){this.loadEmptyBoard();let e=B(6,10);for(let t=0;t<O-1;t++){const n=Math.min(12,Math.max(0,e));for(let e=P-n-1;e<P;e++){const n=e%3,r=[b.COLOR1,b.COLOR2,b.COLOR3][n];this.board[e][t]=r}e+=B(-2,1)}};const G=.5,x=.4;function k(){this.history=[],this.readIndex=-1}w.prototype.loadDigBoard=function(){this.loadStandardBoard();for(let e=0;e<P;e++){let t;const n=Math.random();t=n<G?0:n<G+x?1:2;for(let n=0;n<t;n++)this.board[e][B(0,O)]=b.EMPTY}},k.prototype.addSnapshotToHistory=function(e){this.readIndex+=1,this.history[this.readIndex]=e},k.prototype.rewindOnePiece=function(){this.readIndex-=1,this.readIndex=Math.max(0,this.readIndex)},k.prototype.fastForwardOnePiece=function(){this.readIndex+=1,this.readIndex=Math.min(this.readIndex,this.history.length-1)},k.prototype.loadSnapshotFromHistory=function(){return this.readIndex>=this.history.length?null:this.history[this.readIndex]},k.prototype.resetHistory=function(){this.history=[],this.readIndex=-1};const H=document.getElementById("main-canvas"),Z=document.getElementById("left-panel-toggle-button"),F=document.getElementById("left-panel");document.getElementById("right-panel");let q=!0;F.style.minHeight=c.BOARD_HEIGHT+60,H.setAttribute("height",c.BOARD_HEIGHT),H.setAttribute("width",c.DISPLAY_FULL_WIDTH),Z.innerText="<",Z.addEventListener("click",(function(e){q=!q,q?(F.style.marginLeft=0,Z.innerText="<"):(F.style.marginLeft=-290,Z.innerText=">")}));var Q=n(1);const W=n(2),X=n(3),Y=document.getElementById("header-text"),j=document.getElementById("pre-game-config"),V=document.getElementById("parity-stats"),J=document.getElementById("main-canvas"),z=document.getElementById("right-panel"),K=[];for(let e=0;e<c.NUM_ROW;e++){K[e]=[];for(let t=0;t<c.NUM_COLUMN;t++)K[e][t]=c.SquareState.EMPTY}let $,ee,te,ne,re,oe,ie,ae,se,ce,de,ue,le,Se,he,fe,Ee,ge,pe,Ie=new p(K),Ae=new v(K,Ie),De=new w(K),me=new a,_e=(new h(K,Ie),new k),ye=!1;const Re=()=>ee,Te=()=>ne,Le=()=>ye;function Me(){ee=te,te=new _(me.getNextPiece(),K),Ie.drawNextBox(te),Ie.drawPieceStatusDisplay(me.getStatusDisplay())}function ve(){de=0,he=0,ue=0,Se=[],ce=0,fe=W.getFrameSkipCount(),le=0,$.resetLocalVariables(),Ee=0,ge=0,pe=0}function Ue(){switch(W.getStartingBoardType()){case c.StartingBoardType.EMPTY:De.loadEmptyBoard();break;case c.StartingBoardType.DIG_PRACTICE:De.loadDigBoard();break;case c.StartingBoardType.CUSTOM:ie==c.GameState.EDIT_STARTING_BOARD||De.loadEmptyBoard()}var e;ne=W.getStartingLevel(),oe=W.shouldTransitionEvery10Lines()?10:(e=ne)<10?10*(e+1):e<=15?100:10*(e-5),me.generatePieceSequence(),te=new _(me.getNextPiece(),K),Me(),ae=0,se=0,re=0,ye=!1,ve(),ke(),le=90,ie=c.GameState.FIRST_PIECE,document.activeElement.blur(),Ie.drawBoard(),Ie.drawCurrentPiece(),Pe(),Be(),we(),Ge()}function Ne(){ie==c.GameState.FIRST_PIECE&&0==le?ie=c.GameState.RUNNING:ie==c.GameState.LINE_CLEAR&&0==ue?ie=c.GameState.ARE:ie==c.GameState.ARE&&0==de?(ae+=he,he=0,Be(),ke(),Ie.drawCurrentPiece(),!function(){const e=ee.activeTetromino;for(let t=0;t<e.length;t++)for(let n=0;n<e[t].length;n++)if(e[t][n]&&K[ee.y+t][ee.x+n])return!0;return!1}()?ie=c.GameState.RUNNING:(ie=c.GameState.GAME_OVER,Ge(),Pe(),console.log("Average:",(Ee/ge).toFixed(3),"Max:",pe.toFixed(3)))):ie==c.GameState.RUNNING&&(ue>0?ie=c.GameState.LINE_CLEAR:de>0&&(ie=c.GameState.ARE))}function Ce(){if(!ye){switch(ie){case c.GameState.FIRST_PIECE:le-=1,$.handleInputsThisFrame();break;case c.GameState.LINE_CLEAR:ue-=1,Ie.drawLineClears(Se,c.LINE_CLEAR_DELAY-ue),0==ue&&function(){const e=Se.length;for(const e of Se){for(let t=e;t>1;t--)for(let e=0;e<c.NUM_COLUMN;e++)K[t][e]=K[t-1][e];for(let e=0;e<c.NUM_COLUMN;e++)K[0][e]=c.SquareState.EMPTY}Se=[],e>0&&(re+=e,4==e&&(se+=1),(W.shouldTransitionEveryLine()||re>=oe)&&(ne+=1,oe+=10),he+=c.REWARDS[e]*(ne+1),Ie.drawBoard(),Ie.drawNextBox(te))}();break;case c.GameState.ARE:de-=1;break;case c.GameState.RUNNING:$.handleInputsThisFrame(),$.getIsSoftDropping()?ce=0:(ce+=1,ce>=Object(c.GetGravity)(ne)&&(xe(),ce=0))}Ne()}}function Oe(){if(fe-=1,0==fe){fe=W.getFrameSkipCount();const e=window.performance.now();Ce();const t=window.performance.now()-e;ge+=1,Ee+=t,pe=Math.max(pe,t)}requestAnimationFrame(Oe)}function Pe(){let e="";if(ye)e="Paused";else switch(ie){case c.GameState.START_SCREEN:e="Welcome to Tetris Trainer!";break;case c.GameState.EDIT_STARTING_BOARD:e="Use your mouse to edit the board, then click enter to start!";break;case c.GameState.GAME_OVER:e="Game over!"}Y.innerText=e}function be(e,t){let n=0;for(let r=0;r<c.NUM_ROW;r++)for(let o=Math.max(0,e);o<Math.min(t,10);o++)if(K[r][o]!=c.SquareState.EMPTY){n+=(r+o)%2==0?1:-1}return Math.abs(n)}function we(){const e=be(0,5),t=be(3,7),n=be(5,10);V.innerText=`Left: ${e} \nMiddle: ${t} \nRight: ${n}`}function Be(){Ie.drawLevelDisplay(ne),Ie.drawScoreDisplay(ae),Ie.drawLinesDisplay(re),Ie.drawTetrisRateDisplay(se,re)}function Ge(){ie==c.GameState.START_SCREEN?j.style.visibility="visible":j.style.visibility="hidden"}function xe(){return ee.shouldLock()?(function(){const e=ee.getHeightFromBottom();ee.lock(),$.onPieceLock(),Ie.drawBoard(),we(),Me(),Se=function(){let e=[];for(let t=0;t<c.NUM_ROW;t++){let n=!0;for(let e=0;e<c.NUM_COLUMN;e++)if(K[t][e]==c.SquareState.EMPTY){n=!1;break}n&&e.push(t)}return e}(),Se.length>0&&(ue=c.LINE_CLEAR_DELAY);he+=Object(c.CalculatePushdownPoints)($.getCellsSoftDropped()),de=10+2*Math.floor((e+2)/4)}(),!1):(Ie.unDrawCurrentPiece(),ee.moveDown(),Ie.drawCurrentPiece(),!0)}function ke(){_e.addSnapshotToHistory([ee.id,te.id,me.getReadIndex(),ne,re,oe,ae,se,JSON.parse(JSON.stringify(K))])}function He(){const e=_e.loadSnapshotFromHistory();let t,n,o,i;if(null!==e){[n,o,i,ne,re,oe,ae,se,t]=e;for(let e=0;e<c.NUM_ROW;e++)for(let n=0;n<c.NUM_COLUMN;n++)K[e][n]=t[e][n];ee=new _(r[n],K),te=new _(r[o],K),me.setReadIndex(i),Ie.drawPieceStatusDisplay(me.getStatusDisplay()),ve(),le=90,ie=c.GameState.FIRST_PIECE,document.activeElement.blur(),Ie.drawBoard(),Ie.drawCurrentPiece(),Ie.drawNextBox(te),Pe(),Be(),we(),Ge()}}function Ze(){ye=!ye,Pe()}function Fe(){return ie==c.GameState.FIRST_PIECE||ie==c.GameState.RUNNING||ie==c.GameState.ARE||ie==c.GameState.LINE_CLEAR}J.addEventListener("mousedown",(function(e){Ae.onMouseDown(e)})),J.addEventListener("mousemove",(function(e){Ae.onMouseDrag(e)})),J.addEventListener("mouseup",(function(e){Ae.onMouseUp(e)})),z.addEventListener("mouseleave",(function(e){Ae.onMouseUp(e)})),document.addEventListener("keydown",e=>{$.keyDownListener(e)}),document.addEventListener("keyup",e=>{$.keyUpListener(e)});const qe={"preset-standard":Q.i,"preset-standard-tap":Q.j,"preset-dig-practice":Q.b,"preset-drought":Q.c,"preset-killscreen":Q.e,"preset-slow-killscreen":Q.h,"preset-slow-19":Q.g,"preset-custom-sequence":Q.a};function Qe(){for(const e in qe)document.getElementById(e).classList.remove("selected")}for(const e in qe){const t=qe[e];document.getElementById(e).addEventListener("click",n=>{X.loadPreset(t),Qe(),console.log("selecting:",e),document.getElementById(e).classList.add("selected")})}document.getElementById("preset-edit-board").addEventListener("click",e=>{X.loadPreset(Q.d),ne=W.getStartingLevel(),De.loadEmptyBoard(),ee=null,Ie.drawBoard(),ie=c.GameState.EDIT_STARTING_BOARD,Ge(),Pe()}),document.getElementById("start-button").addEventListener("click",e=>Ue()),document.addEventListener("keydown",e=>{switch(e.key){case"r":(Fe()||ie==c.GameState.GAME_OVER)&&Ue();break;case"v":_e.rewindOnePiece(),He();break;case"b":_e.fastForwardOnePiece(),He();break;case"Enter":ie==c.GameState.GAME_OVER?(ie=c.GameState.START_SCREEN,Pe(),Ge()):ie==c.GameState.START_SCREEN||ie==c.GameState.EDIT_STARTING_BOARD?Ue():Fe()&&Ze();break;case"q":ie=c.GameState.START_SCREEN,Pe(),Ge()}}),$=new T(xe,(function(){Ie.unDrawCurrentPiece();const e=ee.moveLeft();return Ie.drawCurrentPiece(),e}),(function(){Ie.unDrawCurrentPiece();const e=ee.moveRight();return Ie.drawCurrentPiece(),e}),(function(){Ie.unDrawCurrentPiece(),ee.rotate(!1),Ie.drawCurrentPiece()}),(function(){Ie.unDrawCurrentPiece(),ee.rotate(!0),Ie.drawCurrentPiece()}),Ze,(function(){return ie}),(function(){return de})),ve(),document.getElementById("preset-standard").click(),window.setTimeout(()=>{Ie.drawBoard(),Ie.drawNextBox(null),$.refreshDebugText(),Pe(),we(),Be(),Oe()},20)}]);