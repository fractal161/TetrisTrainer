!function(t){var e={};function o(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=t,o.c=e,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(n,i,function(e){return t[e]}.bind(null,i));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="dist",o(o.s=0)}([function(t,e,o){"use strict";o.r(e),o.d(e,"SquareState",(function(){return N})),o.d(e,"GetCurrentPiece",(function(){return et})),o.d(e,"GetLevel",(function(){return ot}));const n={Z:[[[[0,0,0,0],[0,1,1,0],[0,0,1,1]],[[0,0,0,1],[0,0,1,1],[0,0,1,0]]],2,"Z"],S:[[[[0,0,0,0],[0,0,1,1],[0,1,1,0]],[[0,0,1,0],[0,0,1,1],[0,0,0,1]]],3,"S"],T:[[[[0,0,0,0],[0,1,1,1],[0,0,1,0]],[[0,0,1,0],[0,1,1,0],[0,0,1,0]],[[0,0,1,0],[0,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,1],[0,0,1,0]]],1,"T"],O:[[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]],1,"O"],L:[[[[0,0,0,0],[0,1,1,1],[0,1,0,0]],[[0,1,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,1],[0,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,1]]],2,"L"],I:[[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]],1,"I"],J:[[[[0,0,0,0],[0,1,1,1],[0,0,0,1]],[[0,0,1,0],[0,0,1,0],[0,1,1,0]],[[0,1,0,0],[0,1,1,1],[0,0,0,0]],[[0,0,1,1],[0,0,1,0],[0,0,1,0]]],3,"J"]},i=Object.values(n),r=document.getElementById("piece-sequence");let a="",s=0,l=!1;function c(){}c.prototype.startReadingPieceSequence=function(){a=r.value,a.length>0&&(l=!0,s=0)},c.prototype.chooseNextPiece=function(t){return l?this.getPresetPiece():(l=!1,this.getRandomPiece(t))},c.prototype.getStatusString=function(){return l?"Piece "+(s+1)+" of "+a.length:"Random piece"},c.prototype.getPresetPiece=function(){const t=a[s],e=n[t];return s+=1,s>=a.length&&(l=!1,s=0),e},c.prototype.getRandomPiece=function(t){let e=Math.floor(Math.random()*(i.length+1));e!=i.length&&t!==i[e][2]||(e=Math.floor(Math.random()*i.length));return i[e]};const d={0:"rgb(0,88,248)",1:"rgb(0,168,0)",2:"rgb(216,0,204)",3:"rgb(0,88,248)",4:"rgb(228,0,88",5:"rgb(88,248,152)",6:"rgb(248,56,0)",7:"rgb(104,68,252)",8:"rgb(0,88,248)",9:"rgb(248,56,0)"},u={1:d,2:{0:"rgb(60,188,252)",1:"rgb(148,248,24)",2:"rgb(248,120,248)",3:"rgb(88,216,84)",4:"rgb(88,248,152)",5:"rgb(104,136,252)",6:"rgb(124,124,124)",7:"rgb(168,0,32)",8:"rgb(248,56,0)",9:"rgb(252,160,68)"},3:Object.assign(d)},h=Object.freeze({LEFT:1,RIGHT:2,DOWN:3,UP:4}),f={1:40,2:100,3:300,4:1200},g={0:48,1:43,2:38,3:33,4:28,5:23,6:18,7:13,8:8,9:6,10:5,11:5,12:5,13:4,14:4,15:4,16:3,17:3,18:3,19:2,29:1},p="running",m="paused",y="game over",b="start screen",v="piece active",w="are",S="line clear",L=document.getElementById("paste-area"),I=document.getElementById("pasted-image");let x=!1,T=[];function B(t,e){var o;this.board=t,this.canvas=e,o=this,L.onpaste=function(t){for(var e=(t.clipboardData||t.originalEvent.clipboardData).items,n=null,i=0;i<e.length;i++)0===e[i].type.indexOf("image")&&(n=e[i].getAsFile());if(null!==n){var r=new FileReader;r.onload=function(t){I.onload=function(){o.getBoardStateFromImage(I)},I.src=t.target.result},r.readAsDataURL(n)}}}B.prototype.resetBoard=function(){for(let t=0;t<20;t++)for(let e=0;e<10;e++)this.board[t][e]=x?T[t][e]:N.empty},B.prototype.didLoadBoardStateFromImage=function(){return x},B.prototype.getBoardStateFromImage=function(t){var e=document.getElementById("dummy-canvas"),o=e.getContext("2d");e.width=t.width,e.height=t.height,o.drawImage(t,0,0);const n=(t.height/20+t.width/10)/2-.3;for(let t=0;t<10;t++)for(let e=0;e<20;e++){const i=Math.round((t+.5)*n),r=Math.round((e+.5)*n),a=o.getImageData(i,r,1,1).data;Math.max(a[0],a[1],a[2])>60?this.board[e][t]=N.color1:this.board[e][t]=N.empty,o.fillStyle="GREEN",o.fillRect(i,r,5,5)}!function(t){let e=!1;for(let o=19;o>=0;o--)if(e)for(let e=0;e<10;e++)t[o][e]=N.empty;else{let n=!0;for(let e=0;e<10;e++)if(t[o][e]!=N.empty){n=!1;break}n&&(e=!0)}}(this.board),T=JSON.parse(JSON.stringify(this.board)),this.canvas.drawBoard(),x=!0};const F=document.getElementById("main-canvas"),k=F.getContext("2d");function R(t){this.board=t}function H(t,e,o){this.rotationList=t[0],this.colorId=t[1],this.id=t[2],this.board=e,this.canvas=o,this.rotationIndex=0,this.activeTetromino=this.rotationList[this.rotationIndex],this.x=3,this.y=-1}R.prototype.onClick=function(t){const e=F.getBoundingClientRect(),o=t.clientX-e.left,n=t.clientY-e.top;console.log("x: "+o+" y: "+n);const i=Math.floor(n/28),r=Math.floor(o/28);this.board[i][r]=this.board[i][r]==N.empty?N.color1:N.empty,this.drawBoard()},R.prototype.drawLineClears=function(t,e){if(e>=15)return;const o=5+Math.floor(e/3),n=9-o;for(const e of t)k.fillStyle="black",k.fillRect(28*n,28*e,28,28),k.fillRect(28*o,28*e,28,28)},R.prototype.drawSquare=function(t,e,o,n=!1){k.fillStyle=o,k.fillRect(28*t,28*e,28,28),n&&"black"!==o&&(k.fillStyle="white",k.fillRect(28*t+4,28*e+4,20,20)),"black"!==o&&(k.fillStyle="white",k.fillRect(28*t,28*e,4,4),k.fillRect(28*t+4,28*e+4,4,4),k.fillRect(28*t+4+4,28*e+4,4,4),k.fillRect(28*t+4,28*e+4+4,4,4)),k.strokeStyle="BLACK",k.strokeRect(28*t,28*e,28,28),k.strokeRect(28*t,28*e,28,28)},R.prototype.drawNextBox=function(t){const e="I"===t.id||"O"===t.id?11.5:11,o="I"===t.id?1.75:2.25,n=u[t.colorId][ot()%10];k.fillStyle="BLACK",k.fillRect(308,56,140,126);for(let i=0;i<t.activeTetromino.length;i++)for(let r=0;r<t.activeTetromino[i].length;r++)t.activeTetromino[i][r]&&this.drawSquare(e+r,o+i,n,1===t.colorId)},R.prototype.drawPieceStatusString=function(t){k.fillStyle="WHITE",k.fillRect(308,8,100,40),k.font="13px monospace",k.fillStyle="BLACK",k.fillText(t,308,28,100)},R.prototype.drawPiece=function(t){if(null==t)return;const e=ot(),o="T"===t.id||"O"===t.id||"I"===t.id;for(let n=0;n<t.activeTetromino.length;n++)for(let i=0;i<t.activeTetromino[n].length;i++)t.activeTetromino[n][i]&&(0!==t.colorId?this.drawSquare(t.x+i,t.y+n,u[t.colorId][e%10],o):this.drawSquare(t.x+i,t.y+n,"black",o))},R.prototype.drawBoard=function(){const t=ot();for(let e=0;e<20;e++)for(let o=0;o<10;o++){let n=this.board[e][o];0!==n?this.drawSquare(o,e,u[n][t%10],1===n):this.drawSquare(o,e,"black",1===n)}this.drawPiece(et())},H.prototype.equals=function(t){return this.id===t.id},H.prototype.getHeightFromBottom=function(){let t=0;for(let e=0;e<this.activeTetromino.length;e++)for(let o=0;o<this.activeTetromino[e].length;o++)this.activeTetromino[e][o]&&(t=Math.max(t,this.y+e));return 20-t},H.prototype.shouldLock=function(){return this.collision(0,1,this.activeTetromino)},H.prototype.moveDown=function(){this.y++,this.canvas.drawBoard()},H.prototype.moveRight=function(){return!this.collision(1,0,this.activeTetromino)&&(this.x++,this.canvas.drawBoard(),!0)},H.prototype.moveLeft=function(){return!this.collision(-1,0,this.activeTetromino)&&(this.x--,this.canvas.drawBoard(),!0)},H.prototype.rotate=function(t){const e=t?-1:1,o=(this.rotationIndex+e+this.rotationList.length)%this.rotationList.length,n=this.rotationList[o];this.collision(0,0,n)||(this.rotationIndex=o,this.activeTetromino=this.rotationList[this.rotationIndex],this.canvas.drawBoard())},H.prototype.lock=function(){for(let t=0;t<this.activeTetromino.length;t++)for(let e=0;e<this.activeTetromino[t].length;e++)this.activeTetromino[t][e]&&(this.board[this.y+t][this.x+e]=this.colorId);this.canvas.drawBoard()},H.prototype.collision=function(t,e,o){for(let n=0;n<o.length;n++)for(let i=0;i<o[n].length;i++){if(!o[n][i])continue;let r=this.x+i+t,a=this.y+n+e;if(r<0||r>=10||a>=20)return!0;if(!(a<0)&&0!=this.board[a][r])return!0}return!1};function C(t,e,o,n,i,r,a,s,l){this.leftHeld=!1,this.rightHeld=!1,this.downHeld=!1,this.dasCount=0,this.softDroppedLastFrame=!1,this.togglePauseFunc=r,this.moveDownFunc=t,this.moveLeftFunc=e,this.moveRightFunc=o,this.rotateLeftFunc=n,this.rotateRightFunc=i,this.getGameStateFunc=a,this.getGameSubStateFunc=s,this.getAREFunc=l}C.prototype.handleInputsThisFrame=function(){if(!(this.downHeld+this.leftHeld+this.rightHeld>1)){if(this.downHeld&&!this.softDroppedLastFrame){console.log("Soft dropping");return this.moveDownFunc()||(this.downHeld=!1),void(this.softDroppedLastFrame=!0)}this.softDroppedLastFrame=!1,this.leftHeld?this.handleHeldDirection(h.LEFT):this.rightHeld&&this.handleHeldDirection(h.RIGHT)}},C.prototype.isSoftDropping=function(){return this.downHeld},C.prototype.handleHeldDirection=function(t){if(this.dasCount=Math.min(16,this.dasCount+1),1==this.dasCount||16==this.dasCount){(t==h.LEFT?this.moveLeftFunc():this.moveRightFunc())?16==this.dasCount&&(this.dasCount=10):this.dasCount=16}},C.prototype.keyDownListener=function(t){if(!t.repeat){if(this.getGameStateFunc()==p)switch(t.keyCode){case 37:0==this.getAREFunc()&&(this.dasCount=0),this.leftHeld=!0;break;case 39:0==this.getAREFunc()&&(this.dasCount=0),this.rightHeld=!0;break;case 90:this.rotateLeftFunc();break;case 88:this.rotateRightFunc();break;case 40:this.downHeld=!0}80==t.keyCode&&this.togglePauseFunc()}},C.prototype.keyUpListener=function(t){const e=this.getGameStateFunc(),o=this.getGameSubStateFunc();e==p&&(37==t.keyCode?this.leftHeld=!1:39==t.keyCode?this.rightHeld=!1:40==t.keyCode&&o==v&&(this.downHeld=!1))},C.prototype.getDebugText=function(){let t="",e="";for(let t=0;t<this.dasCount;t++)e+="x";return t+="DAS: "+this.dasCount+"\n"+e,t+="\nLeftKey: "+this.leftHeld,t+="\nRightKey: "+this.rightHeld,t+="\nDownKey: "+this.downHeld,t},C.prototype.resetLocalVariables=function(){this.leftHeld=!1,this.rightHeld=!1,this.downHeld=!1,this.dasCount=0,this.softDroppedLastFrame=!1};const E=document.getElementById("score"),P=document.getElementById("header-text"),D=document.getElementById("debug"),O=document.getElementById("stats"),M=document.getElementById("game-options-form"),q=document.getElementById("start-game"),G=(document.getElementById("restart-game"),document.getElementById("level-select")),j=document.getElementById("main-canvas"),N={empty:0,color1:1,color2:2,color3:3};let A,K=[];for(let t=0;t<20;t++){K[t]=[];for(let e=0;e<10;e++)K[t][e]=N.empty}let _=new R(K);j.addEventListener("mousedown",(function(t){console.log("onClick"),_.onClick(t)}));let J,U,W,V,Z,z,X,Y,Q,$=new c,tt=new B(K,_);const et=()=>J,ot=()=>W;function nt(){let t="";switch(V){case b:t="Welcome to Tetris Trainer!";break;case p:t="";break;case y:t="Game over!";break;case m:t="Paused"}P.innerText=t}function it(){J=U,function(){const t=J.activeTetromino;for(let e=0;e<t.length;e++)for(let o=0;o<t[e].length;o++)if(t[e][o]&&K[J.y+e][J.x+o])return V=y,void nt()}(),_.drawPieceStatusString($.getStatusString()),U=new H($.chooseNextPiece(J.id),K,_),_.drawPiece(J),_.drawNextBox(U)}function rt(){Z=0,z=0,X=0,Y=0,Q=[],W=0,V=b,A.resetLocalVariables()}function at(){if(J.shouldLock()){const t=J.getHeightFromBottom();return J.lock(),it(),Q=function(){let t=[];for(let e=0;e<20;e++){let o=!0;for(let t=0;t<10;t++)if(K[e][t]==N.empty){o=!1;break}o&&t.push(e)}return t}(),Q.length>0&&(Y=18),X=10+2*Math.floor((t+2)/4),!1}return J.moveDown(),!0}A=new C(at,(function(){return J.moveLeft()}),(function(){return J.moveRight()}),(function(){J.rotate(!0)}),(function(){J.rotate(!1)}),(function(){V==p?(V=m,nt()):V==m&&(V=p,nt())}),(function(){return V}),(function(){return Y>0?S:X>0?w:v}),(function(){return X})),document.addEventListener("keydown",t=>{A.keyDownListener(t)}),document.addEventListener("keyup",t=>{A.keyUpListener(t)}),M.addEventListener("submit",t=>{t.preventDefault(),q.focus(),function(){rt(),$.startReadingPieceSequence(),tt.resetBoard();const t=parseInt(G.value);W=Number.isInteger(t)&&t>0?t:0,U=new H($.chooseNextPiece(""),K,_),it(),_.drawBoard(),nt(),V=p}()}),rt(),_.drawBoard(),nt(),function t(){V==p&&(Y>0?(Y-=1,_.drawLineClears(Q,18-Y),0==Y&&function(){for(const t of Q){for(let e=t;e>1;e--)for(let t=0;t<10;t++)K[e][t]=K[e-1][t];for(let t=0;t<10;t++)K[0][t]=N.empty}const t=Q.length;t>0&&(_.drawBoard(),Z+=f[t]*(W+1),E.innerText="Score: "+Z),Q=[]}()):X>0?X-=1:(A.handleInputsThisFrame(),z+=1,D.innerText=A.getDebugText(),function(){let t=0;for(let e=0;e<20;e++)for(let o=0;o<10;o++)if(K[e][o]!=N.empty){t+=(e+o)%2==0?1:-1}O.innerText="Parity: "+t}(),!A.isSoftDropping()&&z>=g[W]&&(at(),z=0))),window.setTimeout(t,16.33)}()}]);